rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ (Users)
    match /Users/{userId} {
      // ë³¸ì¸ì€ ë³¸ì¸ ë¬¸ì„œì—ë§Œ ì ‘ê·¼ ê°€ëŠ¥
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // adminì€ ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ì½ê¸°/ìˆ˜ì • ê°€ëŠ¥
      allow read, update: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == "admin";
    }

    // ğŸ‘¥ ì „ì²´ íšŒì› ê´€ë¦¬ (ëŒ€ë¬¸ì Members)
    match /Members/{memberId} {
      // adminì€ ì „ì²´ íšŒì› ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == "admin";
      // teacherëŠ” ë³¸ì¸ ë‹´ë‹¹ ì„¸ë¶€ì‚¬ì—…ì— í•´ë‹¹í•˜ëŠ” íšŒì›ë§Œ ì½ê¸° ê°€ëŠ¥
      allow read: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == "teacher" &&
        resource.data.subProgram in get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.subPrograms;
    }

    // ğŸ‘¥ ì„¸ë¶€ì‚¬ì—…ë³„ ì´ìš©ì ê´€ë¦¬ (ì†Œë¬¸ì members)
    match /members/{memberId} {
      // adminì€ ì „ì²´ ì´ìš©ì ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
      allow read, write: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == "admin";
      // teacherëŠ” ë³¸ì¸ ë‹´ë‹¹ ì„¸ë¶€ì‚¬ì—…ì— í•´ë‹¹í•˜ëŠ” ì´ìš©ìë§Œ ì½ê¸° ê°€ëŠ¥
      allow read: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == "teacher" &&
        resource.data.subProgram in get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.subPrograms;
    }

    // âœ… ì¶œì„ ì •ë³´ (Attendance)
    match /Attendance/{attendanceId} {
      allow read, write: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role in ["admin", "teacher"];
    }

    // ğŸ“Š ì‹¤ì  ìš”ì•½ ì •ë³´ (PerformanceSummary)
    match /PerformanceSummary/{summaryId} {
      // admin, teacherëŠ” ì½ê¸° ê°€ëŠ¥
      allow read: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role in ["admin", "teacher"];
      // adminë§Œ ì“°ê¸° ê°€ëŠ¥
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == "admin";
    }

    // ğŸ§‘â€ğŸ« ê°•ì‚¬-ì„¸ë¶€ì‚¬ì—… ë§¤í•‘ (TeacherSubProgramMap)
    match /TeacherSubProgramMap/{docId} {
      allow read, write: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == "admin";
    }

    // ğŸ” íŒ€-ì„¸ë¶€ì‚¬ì—… ë§¤í•‘ (TeamSubProgramMap)
    match /TeamSubProgramMap/{docId} {
      allow read, write: if request.auth != null &&
        get(/databases/$(database)/documents/Users/$(request.auth.uid)).data.role == "admin";
    }

    // ğŸ”’ ê¸°íƒ€ ëª¨ë“  ë¬¸ì„œëŠ” ì ‘ê·¼ ê¸ˆì§€
    match /{document=**} {
      allow read, write: if false;
    }
  }
}